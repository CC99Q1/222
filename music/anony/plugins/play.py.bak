import re 
from pyrogram import filters, types, enums

from anony import anon, app, config, db, lang, queue, tg, yt
from anony.helpers import buttons, utils
from anony.helpers._play import checkUB
from anony.helpers.fsub import check_force_sub 

# --- [ØªØ¹Ø¯ÙŠÙ„] ØªØ¹Ø¨ÙŠØ± Ù†Ù…Ø·ÙŠ Ø¯Ù‚ÙŠÙ‚ Ù„ÙƒÙ„ Ø±ÙˆØ§Ø¨Ø· ÙŠÙˆØªÙŠÙˆØ¨ ---
YOUTUBE_URL_REGEX = r"(?:https?://)?(?:www\.)?(?:youtube\.com/(?:watch\?v=|live/|shorts/)|youtu\.be/)([a-zA-Z0-9_-]{11})"


@app.on_message(
    filters.command(
        [
            "play",
            "playforce",
            "vplay",
            "vplayforce",
            "Ø´ØºÙ„",
            "ØªØ´ØºÙŠÙ„",
            "Ø´ØºÙ„ ÙÙŠØ¯ÙŠÙˆ",
            "ØªØ´ØºÙŠÙ„ ÙÙŠØ¯ÙŠÙˆ",
        ],
        prefixes=["/", "!", ".", ""],
    )
    & (filters.group | filters.channel)
    & ~app.bl_users
)
@lang.language()
@check_force_sub 
@checkUB
async def play_hndlr(
    _, 
    m: types.Message,
    force: bool = False,
    video: bool = False,
    url: str = None,  
) -> None:
    sent = await m.reply_text(m.lang["play_searching"])

    # ... (Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø´Ø±Ù ÙˆÙ‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ) ...
    playmode_admin = await db.get_play_mode(m.chat.id)
    is_admin = False 
    if m.sender_chat:
        is_admin = True
    elif m.from_user:
        try:
            member = await _.get_chat_member(m.chat.id, m.from_user.id)
            if member.status in (enums.ChatMemberStatus.ADMINISTRATOR, enums.ChatMemberStatus.OWNER):
                is_admin = True
        except Exception:
            is_admin = False 
    if playmode_admin and not is_admin:
        return await sent.edit_text(m.lang["play_admin_only"])
    if len(queue.get_queue(m.chat.id)) >= 20:
        return await sent.edit_text(m.lang["queue_full"])


    query = ""
    file = None
    is_video = video 
    is_live = False
    is_url = False # <-- Ù…ØªØºÙŠØ± Ø¬Ø¯ÙŠØ¯ Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·

   
    if m.command:
        command = m.command[0].lower()
        if command in ["vplay", "vplayforce", "Ø´ØºÙ„ ÙÙŠØ¯ÙŠÙˆ", "ØªØ´ØºÙŠÙ„ ÙÙŠØ¯ÙŠÙˆ"]:
            is_video = True # ØªØ­Ø¯ÙŠØ¯ Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ±ÙŠØ¯ ÙÙŠØ¯ÙŠÙˆ

   
    if m.reply_to_message and m.reply_to_message.media:
        media = tg.get_media(m.reply_to_message)
        if media:
            setattr(sent, "lang", m.lang)
            file = await tg.download(m.reply_to_message, sent)
            is_video = file.video 
            
    if not file:
        if url:
            query = url
        elif len(m.command) > 1:
            query = " ".join(m.command[1:]).strip()
        elif m.reply_to_message and m.reply_to_message.text:
            query = m.reply_to_message.text.strip()


    # --- [ØªØ¹Ø¯ÙŠÙ„ ÙƒØ¨ÙŠØ±] Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· ÙˆØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨ ---
    if query:
        match = re.search(YOUTUBE_URL_REGEX, query)
        if match:
            is_url = True
            query = match.group(0) # Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ù†Ø¸ÙŠÙ Ø§Ù„Ù…ÙƒØªØ´Ù
    # --- Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ---

  
    if file:
        pass # Ø§Ù„Ù…Ù„Ù Ø¬Ø§Ù‡Ø² Ù…Ù† Ø§Ù„Ø±Ø¯
    elif is_url:
        # --- [ØªØ¹Ø¯ÙŠÙ„] Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø·Ù„Ø¨ Ø±Ø§Ø¨Ø·Ø§Ù‹ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø§Ù„Ù…ÙˆØ«ÙˆÙ‚Ø© ---
        await sent.edit_text(m.lang.get("play_fetching_url", "ğŸ” Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·..."))
        # is_video ÙŠØ­Ø¯Ø¯ Ù…Ø§ Ø¥Ø°Ø§ ÙƒÙ†Ø§ Ù†Ø±ÙŠØ¯ Ø§Ù„Ø¨Ø« ÙƒÙÙŠØ¯ÙŠÙˆ Ø£Ùˆ ØµÙˆØª
        file = await yt.get_track_info_from_url(query, sent.id, video=is_video)
    elif query:
        # --- (Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©) Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø·Ù„Ø¨ Ù†ØµØ§Ù‹ØŒ Ø§Ø¨Ø­Ø« Ø¹Ù†Ù‡ ---
        file = await yt.search(query, sent.id, video=is_video)
    else:
        return await sent.edit_text(m.lang["play_usage"])
        

    if file and file.duration_sec == 0:
        is_live = True
        file.video = is_video # Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø« (ØµÙˆØª/ÙÙŠØ¯ÙŠÙˆ) Ù‡ÙŠ Ù…Ø§ Ø·Ù„Ø¨Ù‡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…


    if not file:
        # Ù‡Ù†Ø§ Ø³ØªØ¸Ù‡Ø± Ø±Ø³Ø§Ù„Ø© "Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…" Ø¥Ø°Ø§ ÙØ´Ù„Øª Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        # (ÙˆÙ‡ÙŠ Ø§Ù„Ø¢Ù† `play_not_found`)
        return await sent.edit_text(
            m.lang["play_not_found"].format(config.SUPPORT_CHAT)
        )

    if file.duration_sec > 3600 and file.duration_sec != 0:
        return await sent.edit_text(m.lang["play_duration_limit"])



    user_mention = m.from_user.mention if m.from_user else (
        m.sender_chat.title if m.sender_chat else m.lang["anonymous_admin"]
    )
    file.user = user_mention
    
    if force:
        queue.force_add(m.chat.id, file)
    else:
        position = queue.add(m.chat.id, file)

        if await db.get_call(m.chat.id):
            return await sent.edit_text(
                m.lang["play_queued"].format(
                    position,
                    file.url,
                    file.title,
                    file.duration, # Ø³ØªÙƒÙˆÙ† "LIVE" Ù„Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±
                    user_mention,
                ),
                reply_markup=buttons.play_queued(
                    m.chat.id, file.id, m.lang["play_now"]
                ),
            )

    # --- [ØªØ¹Ø¯ÙŠÙ„] Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¢Ù† Ø³ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ ---
    if not file.file_path:
        try:
            if is_live:
                await sent.edit_text(
                    f"â³ {m.lang.get('live_stream_detected', 'ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ø¨Ø« Ù…Ø¨Ø§Ø´Ø±... Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø±Ø§Ø¨Ø·.')}"
                )
                # is_video Ù‡Ù†Ø§ ØµØ­ÙŠØ­Ø© (Ø¥Ù…Ø§ true Ø£Ùˆ false) Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                file.file_path = await yt.get_stream_link(file.id, video=is_video)
                if not file.file_path:
                    raise Exception("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø±Ø§Ø¨Ø· Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±.")
            
            else: # Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø¨Ø«Ø§Ù‹ Ù…Ø¨Ø§Ø´Ø±Ø§Ù‹ (Ù…Ù„Ù Ø¹Ø§Ø¯ÙŠ)
                file.file_path = await yt.download(file.id, video=is_video)
        
        except Exception as e:
            print(f"[Play.py] Error in download/stream_link: {e}")
            await anon.stop(m.chat.id)
            # Ù‡Ø°Ù‡ Ù‡ÙŠ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ© Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø©
            return await sent.edit_text(
                m.lang["error_no_file"].format(config.SUPPORT_CHAT)
            )
    # --- [Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„] ---

    await anon.play_media(
        chat_id=m.chat.id, message=sent, media=file, _lang=m.lang
    )
